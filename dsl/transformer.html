<!DOCTYPE html>

<html>
<head>
  <title>transformer.rb</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>transformer.rb</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h3 id="introduction">Introduction</h3>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>An <em>aAUTOMATOR</em> Robot specifies steps for doing web scraping of a
page or a set of pages. Each robot is built from several
transformers connected in the shape of a graph. Each transformer
type specifies some elemental operation to make. They are
parametrized and combined to create a whole robot. This robot is
specified in a XML format.</p>
<p>Here we define a DSL that we call <em>minilanguage</em>. It eases the
creation of <em>aAUTOMATOR</em> robots, so no longer is needed to create
verbose XML files. Instead we can use a <em>minilanguage</em> string to
define it.</p>
<p>We can create a new <em>aAUTOMATOR</em> robot by feeding a minilanguage
string to <em>Language</em>. <em>Language</em> class interprets it and creates a
tree of <em>Transformer</em> objects. This <em>Transformer</em>‘s tree resembles
<em>aAUTOMATOR</em> XML format so the latter is easy to generate.</p>
<p><em>Language</em> interprets the <em>minilanguage</em> string by using the <code>eval</code>
capabilities of Ruby. At <em>Language</em> class there are methods for
creating transformers of each individual type. In order not to have
to define manually a method for each type of Transformer, we
generate them dynamically.</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>We include java packages for generating the XML.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">require</span> <span class="hljs-string">'java'</span>
<span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">XML</span></span>
  include_package <span class="hljs-string">'javax.xml.parsers'</span>
  include_package <span class="hljs-string">'org.w3c.dom'</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h3 id="-transformer-as-template-for-new-subclasses"><em>Transformer</em> as template for new subclasses</h3>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>We define methods to ease the definition of new <em>Transformer</em>
subclasses. These methods are called when the class is being
constructed and parametrize the behavior of the generated
subclass. Each generated <em>Transformer</em> subclass receives the values
for the parameters it requires when its constructor is
called. <em>Transformer</em> class will be reopened.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Transformer</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>The <code>@variables</code> used inside of class methods(<code>self.method_name</code>)
are local to each subclass. They are instance variables of each
class metaclass.</p>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>This method is intended to be used inside the body of subclasses
from Transformer. It stores the value of the class as a symbol.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.transformer_class value
    <span class="hljs-variable">@transformer_class</span> = value.to_sym
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.transformer_class_symbol
    <span class="hljs-variable">@transformer_class</span>
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Register a custom name for this Transformer subclass. By default,
the generated method name is built from the class name. But
sometimes that isn’t suitable and a custom name must be provided.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.custom_name name
    <span class="hljs-variable">@custom_name</span> = name
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.get_custom_name
    <span class="hljs-variable">@custom_name</span>
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>It stores a new param definition. This method is intended to be used
inside the body of subclasses from Transformer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.param(name, hash)
    params_definitions &lt;&lt; <span class="hljs-constant">ParamDefinition</span>.new(name, hash)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.params_definitions
    (<span class="hljs-variable">@params_definitions</span>||=[])
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>It stores a param definition. It has a name, if it’s required and a
default value. Each <em>Transformer</em> subclass has some different
<em>ParamDefinition</em>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParamDefinition</span></span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.default_value paramDefinition
    paramDefinition &amp;&amp; paramDefinition.default_value
  <span class="hljs-keyword">end</span>

  <span class="hljs-keyword">attr_accessor</span> <span class="hljs-symbol">:name</span>
  <span class="hljs-keyword">attr_accessor</span> <span class="hljs-symbol">:required</span>
  <span class="hljs-keyword">attr_accessor</span> <span class="hljs-symbol">:default_value</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>initialize(name, params)
    <span class="hljs-keyword">self</span>.name = name.to_sym
    <span class="hljs-keyword">self</span>.required = params[<span class="hljs-symbol">:required</span>] &amp;&amp; <span class="hljs-keyword">true</span>
    <span class="hljs-keyword">self</span>.default_value = params[<span class="hljs-symbol">:default_value</span>]
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>We reopen <em>Transformer</em> class to add a hook: <code>self.inherited</code> is
called each time a new subclass of <em>Transformer</em> is defined.</p>
<p>This is a partial definition. <em>Transformer</em> class will be reopened.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Transformer</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Whenever a new subclass of <em>Transformer</em> is created, we tell
Language. We also keep track of the subclasses added.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.inherited subclass
    <span class="hljs-constant">Language</span>.new_type_of_transformer(subclass)
    (<span class="hljs-variable">@@subclasses</span> ||= []) &lt;&lt; subclass
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>The name of the method to be added to <em>Language</em>. It’s created from
the name of the class with the first letter in lowercase, unless
it’s has been customized.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.language_method_name
    <span class="hljs-keyword">self</span>.get_custom_name || <span class="hljs-keyword">self</span>.lowercase_first(<span class="hljs-keyword">self</span>.to_s)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.lowercase_first word
    word[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].downcase + word[<span class="hljs-number">1</span>, word.length - <span class="hljs-number">1</span>]
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>In <em>Language</em> class an instance method is created for each of the
subclasses of <em>Transformer</em>. This is a partial
definition. <em>Language</em> class will be reopened.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Language</span></span>

  <span class="hljs-variable">@@pending_method_definitions</span> = []</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Once a transformer class is created, a method that creates a
transformer instance of that type is <em>eventually</em> added to
Language. The newly generated method will call
<code>transformer_added_action</code> with the provided parameters.</p>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>We can’t define the new method immediately because when the
<code>inherited</code> hook is called the body of the Transformer subclass has
not been executed yet. <code>language_method_name</code> wouldn’t still be
defined.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.new_type_of_transformer transformer_klass
    <span class="hljs-variable">@@pending_method_definitions</span> &lt;&lt; lambda {
      define_method_for transformer_klass
    }
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p> For example after defining the class <code>PatternMatcher</code> a new method
<code>patternMatcher</code> is defined on <em>Language</em> class, once the
<code>register_pending_method_definitions</code> is called. The methods
generated receive some arguments that will be passed directly to the
class constructor. If a block is provided, it’s evaluated in a new
<em>Language</em> instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.define_method_for transformer_klass
    define_method(transformer_klass.language_method_name) <span class="hljs-keyword">do</span> |*args, &amp;block|
      transformer = transformer_klass.new(*args)
      transformer_added_action(transformer)
      <span class="hljs-keyword">if</span> block
        <span class="hljs-constant">Language</span>.new transformer, &amp;block
      <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">self</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>It invokes all the pending method definitions causing the methods for
each transformer to  be defined.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.register_pending_method_definitions</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>This race condition doesn’t matter because all transformers are
defined before languages are started to be instantiated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    pending = <span class="hljs-constant">Array</span>.new <span class="hljs-variable">@@pending_method_definitions</span>
    <span class="hljs-variable">@@pending_method_definitions</span> = []
    pending.each <span class="hljs-keyword">do</span> |l|
      l.call()
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>

<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Now let’s define some <em>Transformer</em> subclasses that will cause
methods to be added to the minilanguage. Notice how we use
<code>transformer_class</code> and <code>param</code> methods defined before to simplify
the definition of <em>Transformer</em> classes.</p>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>It defines the <code>patternMatcher</code> call on <em>Language</em>. It can be used as
<code>patternMatcher(&#39;regexHere&#39;)</code> or
<code>patternMatcher(:pattern=&gt;&#39;regexHere&#39;)</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PatternMatcher</span> <span class="hljs-inheritance">&lt; <span class="hljs-parent">Transformer</span></span></span>
  transformer_class <span class="hljs-symbol">:PatternMatcher</span>
  param <span class="hljs-symbol">:pattern</span>, <span class="hljs-symbol">:required</span> =&gt; <span class="hljs-keyword">true</span>
  param <span class="hljs-symbol">:dotAll</span>, <span class="hljs-symbol">:default_value</span> =&gt; <span class="hljs-keyword">false</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>It defines the <code>xpath</code> call on <em>Language</em>. It can be used as
<code>xpath(&#39;//a/@href&#39;)</code> or <code>xpath(:Xpath-&gt;&#39;//a/@href&#39;)</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Xpath</span> <span class="hljs-inheritance">&lt; <span class="hljs-parent">Transformer</span></span></span>
  transformer_class <span class="hljs-symbol">:HTMLMatcher</span>
  param <span class="hljs-symbol">:XPath</span>, <span class="hljs-symbol">:required</span> =&gt; <span class="hljs-keyword">true</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>This is not intended to be used as a direct call on <em>Language</em>. It
acts as a container of other transformers. For that you should use
the special calls <code>pipe</code> and <code>branch</code> that accept blocks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleTransformer</span> <span class="hljs-inheritance">&lt; <span class="hljs-parent">Transformer</span></span></span>
  transformer_class <span class="hljs-symbol">:SimpleTransformer</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>It defines the <code>appender</code> call on <em>Language</em>. It can be used as
<code>appender(&#39;&lt;br /&gt;&#39;)</code> or <code>xpath(:append-&gt;&#39;&lt;br /&gt;&#39;)</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Appender</span> <span class="hljs-inheritance">&lt; <span class="hljs-parent">Transformer</span></span></span>
  transformer_class <span class="hljs-symbol">:Appender</span>
  param <span class="hljs-symbol">:append</span>, <span class="hljs-symbol">:required</span> =&gt; <span class="hljs-keyword">true</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>It defines the <code>url</code> call on <em>Language</em>. <code>@@custom_names</code> on
transformer class is used to customize the name. It’s used as <code>url</code>
or <code>url(:description=&gt;&#39;whatever&#39;)</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">URLRetriever</span> <span class="hljs-inheritance">&lt; <span class="hljs-parent">Transformer</span></span></span>
  custom_name <span class="hljs-string">"url"</span>
  transformer_class <span class="hljs-symbol">:URLRetriever</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>It defines the <code>replacer</code> call on <em>Language</em>. It’s used as
<code>replacer(:sourceRE=&gt; &#39;&#39;, :dest=&gt;&#39;&#39;)</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Replacer</span> <span class="hljs-inheritance">&lt; <span class="hljs-parent">Transformer</span></span></span>
  transformer_class <span class="hljs-symbol">:Replacer</span>
  param <span class="hljs-symbol">:sourceRE</span>, <span class="hljs-symbol">:required</span> =&gt; <span class="hljs-keyword">true</span>
  param <span class="hljs-symbol">:dest</span>, <span class="hljs-symbol">:required</span> =&gt; <span class="hljs-keyword">true</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>It defines the <code>decorator</code> call on <em>Language</em>. It’s used as
<code>decorator(:head=&gt; &#39;&lt;p&gt;&#39;, :dest=&gt;&#39;&lt;/p&gt;&#39;)</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Decorator</span> <span class="hljs-inheritance">&lt; <span class="hljs-parent">Transformer</span></span></span>
  transformer_class <span class="hljs-symbol">:Decorator</span>
  param <span class="hljs-symbol">:head</span>, <span class="hljs-symbol">:default_value</span> =&gt; <span class="hljs-string">''</span>
  param <span class="hljs-symbol">:tail</span>, <span class="hljs-symbol">:default_value</span> =&gt; <span class="hljs-string">''</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>It defines the <code>merger</code> call on <em>Language</em>. It’s used as
<code>merger</code>. It has no required parameters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Merger</span> <span class="hljs-inheritance">&lt; <span class="hljs-parent">Transformer</span></span></span>
  transformer_class <span class="hljs-symbol">:Merger</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h3 id="-transformer-instantiation-"><em>Transformer</em> instantiation.</h3>

            </div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>We reopen the <em>Transformer</em> class to show how it’s instantiated. The
initialize constructor is called when calling the method dynamically
generated on <em>Language</em> class.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Transformer</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>As you can see <code>arguments</code> is a variable list of arguments. It can
have zero, one, two or three arguments. If branch parameters are
provided they are the first two. The params are the last one, but
it’s optional.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.split_parameters arguments
    params = (arguments.length == <span class="hljs-number">1</span> || arguments.length == <span class="hljs-number">3</span>) &amp;&amp; arguments.last</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>branch parameters provided</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> arguments.length &gt;= <span class="hljs-number">2</span>
      [arguments[<span class="hljs-number">0</span>, <span class="hljs-number">2</span>], params]</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>no branch parameters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span>
      [[], params]
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>A transformer constructor. It’s called from <em>Language</em> when the
concrete method associated to this class is called. Examples of
calls on <em>Language</em> that can trigger this:</p>
<pre><code>patternMatcher(<span class="hljs-string">'(http://.*)'</span>)
decorator(<span class="hljs-symbol">:head=&gt;<span class="hljs-string">"&lt;h1&gt;"</span></span>, <span class="hljs-symbol">:tail=&gt;<span class="hljs-string">"&lt;/h1&gt;"</span></span>, <span class="hljs-symbol">:description=&gt;<span class="hljs-string">"wrapping"</span></span>)
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>initialize *arguments
    klass = <span class="hljs-keyword">self</span>.<span class="hljs-keyword">class</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Check that <code>transformer_class</code> has been defined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">unless</span> klass.transformer_class_symbol
      raise <span class="hljs-constant">ArgumentError</span>, <span class="hljs-string">"transformer_class must be defined in <span class="hljs-subst">#{klass}</span>"</span>
    <span class="hljs-keyword">end</span>

    branch_parameters, params = klass.split_parameters arguments</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>We ensure the params is in a Hash form, that the branch parameters
are added, and that if a key is not found the value in
default_values is returned.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    params = klass.ensure_params_is_hash(params)
    params = klass.with_branch_params(params, branch_parameters)
    params = klass.with_defaults params</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>We set instance attributes from the params. Notice that if the value
is not present, the default values are used.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-variable">@description</span> = params[<span class="hljs-symbol">:description</span>]
    <span class="hljs-variable">@branchtype</span> = params[<span class="hljs-symbol">:branchtype</span>].to_sym
    <span class="hljs-variable">@branchmergemode</span> = params[<span class="hljs-symbol">:branchmergemode</span>].to_sym
    <span class="hljs-variable">@loop</span> = params[<span class="hljs-symbol">:loop</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>We extract the values from the params for the param definitions and
we generate the accessors.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-variable">@params</span> = (klass.values_for_param_definitions params).freeze
    klass.generate_named_accessors_for_parameters(<span class="hljs-string">"params"</span>)
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>The default values used for the standard parameters. If the value
are equal to these they don’t have to be provided.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-variable">@@default_values</span> = {<span class="hljs-symbol">:branchtype</span> =&gt; <span class="hljs-symbol">:CASCADE</span>, <span class="hljs-symbol">:branchmergemode</span> =&gt; <span class="hljs-symbol">:SCATTERED</span>,
    <span class="hljs-symbol">:loop</span> =&gt; <span class="hljs-keyword">false</span>}</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Create a new hash with the contents of <code>hash</code> and that fallbacks to
<code>@@defaults_values</code> and the param definition if some key is not
found.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.with_defaults hash
    result = <span class="hljs-constant">Hash</span>.new {|hash, key|
      <span class="hljs-keyword">if</span> key == <span class="hljs-symbol">:description</span>
        transformer_class_symbol.to_s
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">if</span> <span class="hljs-variable">@@default_values</span>[key]
          <span class="hljs-variable">@@default_values</span>[key]
        <span class="hljs-keyword">else</span>
          <span class="hljs-constant">ParamDefinition</span>.default_value(find_param_definition(key))
        <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">end</span>
    }
    result.merge! hash
    result
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.find_param_definition name
    params_definitions.find{|p| p.name.to_sym == name.to_sym}
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Add to the params hash the branch params if they exist.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.with_branch_params(hash, branch_params)
    hash[<span class="hljs-symbol">:branchtype</span>] = branch_params[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> branch_params[<span class="hljs-number">0</span>]
    hash[<span class="hljs-symbol">:branchmergemode</span>] = branch_params[<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> branch_params[<span class="hljs-number">1</span>]
    hash
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>If params is a Hash we return early.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.ensure_params_is_hash provided_params_values
    <span class="hljs-keyword">return</span> provided_params_values <span class="hljs-keyword">if</span> <span class="hljs-constant">Hash</span> === provided_params_values</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Otherwise we create a new Hash and if there is only one required
param we set the value of that param for the single value provided.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    single_argument = provided_params_values
    result = {}
    required = params_definitions.find_all {|x| x.required}
    <span class="hljs-keyword">if</span> required.size == <span class="hljs-number">1</span>
      result[required[<span class="hljs-number">0</span>].name] = single_argument
    <span class="hljs-keyword">end</span>
    result
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Extracts from the provided params hash, the actual values taking
into account the default values. It also checks that all the
required parameters without default values are set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.values_for_param_definitions provided_params_values
    result = provided_params_values.clone
    params_definitions.each <span class="hljs-keyword">do</span> |p|
      <span class="hljs-keyword">if</span> !result[p.name] &amp;&amp; p.required &amp;&amp; !p.default_value
        raise <span class="hljs-constant">ArgumentError</span>, <span class="hljs-string">"<span class="hljs-subst">#{p.name}</span> parameter is required"</span>
      <span class="hljs-keyword">end</span>
      result[p.name] = result[p.name] || p.default_value
    <span class="hljs-keyword">end</span>
    result
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>It generates dynamically accessors for the parameters definitions in
this instance, the values are the ones stored in
<code>instance_variable_name</code>. For example for <code>PatternMatcher</code> we
generate <code>pattern</code> and <code>dotAll</code> accessors.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.generate_named_accessors_for_parameters instance_variable_name
    params_definitions.each <span class="hljs-keyword">do</span> |param_definition|
      module_eval &lt;&lt;-<span class="hljs-constant">END</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-comment">#{param_definition.name}</span>
          @<span class="hljs-comment">#{instance_variable_name}[:#{param_definition.name}]</span>
        <span class="hljs-keyword">end</span>
      <span class="hljs-constant">END</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Some accessors for properties common for all transformers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:branchtype</span>
  <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:branchmergemode</span>
  <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:description</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>transformer_class
    <span class="hljs-keyword">self</span>.<span class="hljs-keyword">class</span>.transformer_class_symbol
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>children
    <span class="hljs-constant">Array</span>.new(<span class="hljs-variable">@children</span> || [])
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>loop?
    <span class="hljs-variable">@loop</span>
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>params
    <span class="hljs-variable">@params</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <h3 id="-language-interpretation"><em>Language</em> interpretation</h3>

            </div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>We reopen <em>Transformer</em> to add the methods needed by <em>Language</em> to
manipulate each created transformer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Transformer</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p><em>aAUTOMATOR</em> expects that the loop control is the first element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>do_loop_with loop_control_transformer
    (<span class="hljs-variable">@children</span> ||= []).insert(<span class="hljs-number">0</span>, loop_control_transformer)
    <span class="hljs-variable">@loop</span> = <span class="hljs-keyword">true</span>
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Append a child to this transformer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>add_child child
    (<span class="hljs-variable">@children</span> ||= []) &lt;&lt; child
  <span class="hljs-keyword">end</span>

<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Besides the methods presented here this class contains all the
methods generated by the <em>Transformer</em> subclasses definitions. The
Language uses Ruby blocks to create nested scopes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Language</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>This is the entering point for <em>Language</em>. A new <em>Language</em> instance
is created, against which the <code>language_str</code> is evaluated. For
example if <code>language_str</code> is <code>url | xpath(&#39;//a/@href&#39;)</code> the methods
<code>url</code>, <code>|</code> and <code>xpath</code>, <code>|</code> are executed on the new <em>Language</em>
instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.language_eval language_str, filename=<span class="hljs-keyword">nil</span>, lineno=<span class="hljs-keyword">nil</span>
    language = create_top_level
    args = [language_str, filename, lineno].reject{|x| x.<span class="hljs-keyword">nil</span>?}
    language.instance_eval *args</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>We return the top level generated transformer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    language.transformer
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>The root transformer is a <em>SimpleTransformer</em> that works in cascade
mode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.create_top_level &amp;block
    <span class="hljs-constant">Language</span>.new <span class="hljs-constant">SimpleTransformer</span>.new({}), &amp;block
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Method used in the tests. It’s mostly the same as language_eval but
instead of a string to be evaled it receives a Ruby block of
code.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.interpret &amp;block
    l = create_top_level &amp;block
    l.transformer
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Method called when a new transformer is created using one of the
dynamically defined methods. It adds the created transformer
instance to the current transformer. For example, calling
<code>patternMatcher(&#39;regexHere&#39;)</code> on some <em>Language</em> scope adds it as a
child to this Language’s instance <code>@transformer</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>transformer_added_action transformer
    <span class="hljs-variable">@transformer</span>.add_child transformer
  <span class="hljs-keyword">end</span>
  protected <span class="hljs-symbol">:transformer_added_action</span></pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>This is syntactic sugar. Inside the top level scope or a pipe scope
the <code>|</code> separator can be used to separate several transformer
instantiations. The Ruby statement separator <code>;</code> can be used too,
but <code>|</code> gives it a ‘flowing’ look.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>&gt; other
    <span class="hljs-keyword">self</span> | other
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>| other
    <span class="hljs-keyword">if</span> <span class="hljs-variable">@transformer</span>.branchtype != <span class="hljs-symbol">:CASCADE</span>
      raise <span class="hljs-string">"| can't be used in a pipe branch"</span>
    <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">self</span>
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Constructor for a <em>Language</em>. Both params and block are optional. It
creates a <code>SimpleTransformer</code> as container. It interprets the
optionally provided block in the context of the <em>Language</em> being
created. It also registers the pending method definitions to ensure
that they are available.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>initialize transformer, &amp;block
    <span class="hljs-constant">Language</span>.register_pending_method_definitions
    <span class="hljs-variable">@transformer</span> = transformer
    instance_eval(&amp;block) <span class="hljs-keyword">if</span> block
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>The transformer that is being modified in this <code>Language</code> instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>transformer
    <span class="hljs-variable">@transformer</span>
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>With what we have shown so far we only could create transformers
that don’t have other nested transformers. Now we define some
methods that let us create nested scopes inside a Language. Each
scope is a <em>Language</em> instance so more nested scopes can be created
recursively. This scope methods receive Ruby blocks. Ruby blocks can
be delimited with braces which is a very readable nesting construct.</p>

            </div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>It creates a new minilanguage scope with pipe semantics. For example
a pipe could be:</p>
<pre><code>url | pipe {xpath(<span class="hljs-string">'//a/@href'</span>) |
            patternMatcher(<span class="hljs-string">'(http://.*)'</span>)}
</code></pre><p>A transformer with two children would be created: url and a
SimpleTransformer with xpath and patternMatcher as children:</p>
<pre><code><span class="hljs-constant">SimpleTransformer</span> <span class="hljs-symbol">:branchtype</span> =&gt; <span class="hljs-symbol">:CASCADE</span>
  - url
  - <span class="hljs-constant">SimpleTransformer</span> <span class="hljs-symbol">:branchtype</span> =&gt; <span class="hljs-symbol">:CASCADE</span>
    - xpath
    - patternMatcher
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>pipe &amp;block
    pipe = <span class="hljs-constant">Language</span>.new <span class="hljs-constant">SimpleTransformer</span>.new, &amp;block
    <span class="hljs-variable">@transformer</span>.add_child pipe.transformer
    <span class="hljs-keyword">self</span>
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>It creates a new minilanguage scope with branch semantics. A branch
requires that its type and merge mode are specified as params. The
provided block is interpreted with the newly created instance. The
children of a branch must be separated by newlines, never by <code>|</code>. An
example of branch is:</p>
<pre><code>branch(<span class="hljs-symbol">:BRANCH_DUPLICATED</span>, <span class="hljs-symbol">:COLLAPSED</span>) {
  decorator(<span class="hljs-symbol">:head=&gt;<span class="hljs-string">"&lt;h1&gt;"</span></span>, <span class="hljs-symbol">:tail</span> =&gt; <span class="hljs-string">"&lt;/h1&gt;"</span>)
  url
}
</code></pre><p>It would generate:</p>
<pre><code><span class="hljs-constant">SimpleTransformer</span> <span class="hljs-symbol">:branchtype</span> =&gt; <span class="hljs-symbol">:BRANCH_DUPLICATED</span>
                  <span class="hljs-symbol">:branchmergemode</span> =&gt; <span class="hljs-symbol">:SCATTERED</span>
  - decorator <span class="hljs-symbol">:head</span> =&gt; <span class="hljs-string">"&lt;h1&gt;"</span>, <span class="hljs-symbol">:tail</span> =&gt; <span class="hljs-string">"&lt;/h1&gt;"</span>
  - url
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>branch *params, &amp;block
    <span class="hljs-keyword">unless</span> params[<span class="hljs-number">0</span>] &amp;&amp; params[<span class="hljs-number">1</span>]
      raise <span class="hljs-constant">ArgumentError</span>, <span class="hljs-string">"branchtype and branchmerge mode required"</span>
    <span class="hljs-keyword">end</span>
    branch = <span class="hljs-constant">Language</span>.new(<span class="hljs-constant">SimpleTransformer</span>.new(*params), &amp;block)
    <span class="hljs-variable">@transformer</span>.add_child branch.transformer
    <span class="hljs-keyword">self</span>
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>It tells that the last defined transformer is executed in a loop. The
provided block is used as the loop control. For example:</p>
<pre><code>url { patternMatcher(<span class="hljs-symbol">:pattern=&gt;<span class="hljs-string">"somePattern"</span></span>)}.repeat? {
            patternMatcher(<span class="hljs-symbol">:pattern=&gt;<span class="hljs-string">"somePattern"</span></span>) |
            decorator(<span class="hljs-symbol">:head=&gt;<span class="hljs-string">"someURL"</span></span>)}
</code></pre><p>Notice how a transformer can receive other as children. By default
they are in cascade mode (the same as <code>pipe</code>). This is specially
useful with <code>repeat?</code> blocks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>repeat? *params, &amp;block
    last_transformer = <span class="hljs-variable">@transformer</span>.children.last
    <span class="hljs-keyword">unless</span> last_transformer
      raise <span class="hljs-string">"no transformer to which apply a repeat? clause"</span>
    <span class="hljs-keyword">end</span>
    clause = <span class="hljs-constant">RepeatClause</span>.new(<span class="hljs-constant">SimpleTransformer</span>.new(*params), &amp;block)
    <span class="hljs-keyword">if</span> clause.transformer
      last_transformer.do_loop_with clause.transformer
    <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">self</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>It interprets the parts inside of a <code>repeat?</code> block.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RepeatClause</span> <span class="hljs-inheritance">&lt; <span class="hljs-parent">Language</span></span></span>

  alias_method <span class="hljs-symbol">:standard_added_action</span>, <span class="hljs-symbol">:transformer_added_action</span></pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Instead of adding the created transformer to the container the
children of the repeat clause are stored.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>transformer_added_action transformer
    (<span class="hljs-variable">@transformers</span>||=[]) &lt;&lt; transformer
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>When we want to retrieve the transformer we look at the transformers
that have been added.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>transformer</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>We add them to the implicit container first.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (<span class="hljs-variable">@transformers</span> || []).each <span class="hljs-keyword">do</span> |t|
      standard_added_action t
    <span class="hljs-keyword">end</span>
    <span class="hljs-variable">@transformers</span>.clear <span class="hljs-keyword">if</span> <span class="hljs-variable">@transformers</span></pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>If only one transformer instantiated on the repeat clause we return
it. Otherwise we return the implicit container.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">super</span>.children.size == <span class="hljs-number">1</span>
      <span class="hljs-keyword">super</span>.children[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">super</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <h3 id="-aautomator-xml-building"><em>aAUTOMATOR</em> XML building</h3>

            </div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>It exposes methods to ease the creation of the XML for an
<em>aAUTOMATOR</em> <em>robot</em>. New <em>XMLBuilder</em> instances are created for
each transformer node.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XMLBuilder</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>It creates a new XML Document</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.create
    factory = <span class="hljs-constant">XML::DocumentBuilderFactory</span>.newInstance
    factory.setNamespaceAware <span class="hljs-keyword">false</span>
    <span class="hljs-constant">XMLBuilder</span>.new(factory.newDocumentBuilder.newDocument)
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>A <em>XMLBuilder</em> must have a reference to the document and the node
it’s acting on. At the start that’s the root document.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>initialize(doc, node=doc)
    <span class="hljs-variable">@doc</span> = doc
    <span class="hljs-variable">@node</span> = node
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>When adding a new element a new <em>XMLBuilder</em> is created so that
element can be subsequently modified.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>add_element name
    element = <span class="hljs-variable">@doc</span>.createElement(name)
    <span class="hljs-variable">@node</span>.appendChild(element)
    <span class="hljs-constant">XMLBuilder</span>.new(<span class="hljs-variable">@doc</span>,element)
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Using <em>AttributesWrapper</em> to simplify attribute modification</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>attributes
    <span class="hljs-variable">@attributes_wrapper</span> ||= <span class="hljs-constant">AttributesWrapper</span>.new(<span class="hljs-variable">@node</span>)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>document
    <span class="hljs-variable">@doc</span>
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>node
    <span class="hljs-variable">@node</span>
  <span class="hljs-keyword">end</span>
  protected <span class="hljs-symbol">:node</span></pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Add param element to transformer element with the provided value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>add_param(key, value)
    param_element = <span class="hljs-keyword">self</span>.add_element <span class="hljs-string">'param'</span>
    param_element.attributes[<span class="hljs-string">'key'</span>]= key.to_s
    text = <span class="hljs-variable">@doc</span>.createTextNode(value.to_s)
    param_element.node.appendChild(text)
    param_element
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>It eases the way of setting attributes to an XML Element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AttributesWrapper</span></span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>initialize(element)
    <span class="hljs-variable">@element</span> = element
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>[]=(name,value)
    <span class="hljs-variable">@element</span>.setAttribute(name.to_s,value)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Method to be called from the Java side with the language
string. It’s interpreted by <em>Language</em> and the transformer generated
along its children is converted to XML.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> </span>get_xml str, filename=<span class="hljs-keyword">nil</span>, lineno=<span class="hljs-keyword">nil</span>
  transformer = <span class="hljs-constant">Language</span>.language_eval(str, filename, lineno)
  transformer.convert_to_xml
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>We reopen the <em>Transformer</em> class to define the methods needed to
convert to xml.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Transformer</span></span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>convert_to_xml
    builder = <span class="hljs-constant">XMLBuilder</span>.create
    robot = builder.add_element <span class="hljs-string">'robot'</span>
    robot.attributes[<span class="hljs-string">'version'</span>] = <span class="hljs-string">'1.0'</span>
    <span class="hljs-keyword">self</span>.fill_transformer_element(robot.add_element(<span class="hljs-string">'transformer'</span>))
    builder.document
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>It fills the properties needed for an <em>aAUTOMATOR</em> transformer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>fill_transformer_element builder</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>We set the attributes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    builder.attributes[<span class="hljs-string">'class'</span>] = <span class="hljs-keyword">self</span>.<span class="hljs-keyword">class</span>.transformer_class_symbol.to_s
    builder.attributes[<span class="hljs-string">'branchtype'</span>] = branchtype.to_s
    builder.attributes[<span class="hljs-string">'branchmergemode'</span>] = branchmergemode.to_s
    builder.attributes[<span class="hljs-string">'loop'</span>] = loop?.to_s</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>We add the params as elements.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    params.each_pair <span class="hljs-keyword">do</span> |key, value|
      builder.add_param(key, value)
    <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>We apply this same method recursively to the children</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    children.each <span class="hljs-keyword">do</span> |child|
      child.fill_transformer_element(builder.add_element(<span class="hljs-string">"transformer"</span>))
    <span class="hljs-keyword">end</span>
    builder
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <h3 id="from-aautomator-xml-to-minilanguage">From <em>aAUTOMATOR</em> XML to minilanguage</h3>

            </div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>It takes an XML in <em>aAUTOMATOR</em> format and generates a minilanguage
string that would generate it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> </span>to_minilanguage xml</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>The document element is robot and its children are the top level transformers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  children_to_minilanguage(xml.getDocumentElement, <span class="hljs-string">" | "</span>)
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>It converts the transformer children of an element to minilanguage.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> </span>children_to_minilanguage parent, separator
  result = <span class="hljs-string">""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Lambda that converts an element to minilanguage taking into account
its position.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  generate_element = lambda <span class="hljs-keyword">do</span> |element, index|</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>We retrieve the Transformer class associated to the element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    transformer_class = <span class="hljs-constant">Transformer</span>.get_class_for(element.getAttribute(<span class="hljs-string">"class"</span>))
    <span class="hljs-keyword">unless</span> transformer_class
      raise <span class="hljs-string">"not found class for <span class="hljs-subst">#{element.getAttribute(<span class="hljs-string">'class'</span>)}</span>"</span>
    <span class="hljs-keyword">end</span>

    result &lt;&lt; separator <span class="hljs-keyword">if</span> index &gt; <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>The retrieved transformer_class knows how to convert itself to
minilanguage. We provide a block that knows how to generate the
children. It basically calls this method recursively.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    result &lt;&lt; transformer_class.to_minilanguage(element) {|sep|
      children_to_minilanguage(element, sep)
    }
    loop_control = get_loop_control(element)
    <span class="hljs-keyword">unless</span> loop_control.empty?
      result &lt;&lt; <span class="hljs-string">".repeat?{\n"</span>
      loop_control.each_with_index &amp;generate_element
      result &lt;&lt; <span class="hljs-string">"}"</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
  get_transformers(parent).each_with_index &amp;generate_element
  result
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>If the transformer has the loop property the first transformer will
work as loop control. Otherwise all work as standard transformers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> </span>partition_transformers parent
  all = children_list(parent).select_with_name(<span class="hljs-string">"transformer"</span>).to_a
  is_loop = parent.getAttribute(<span class="hljs-string">'loop'</span>) =~ <span class="hljs-regexp">/true/</span>
  <span class="hljs-keyword">if</span> is_loop
    [all[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>], all[<span class="hljs-number">1</span>, all.length - <span class="hljs-number">1</span>]]
  <span class="hljs-keyword">else</span>
     [[], all]
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> </span>get_transformers parent
  partition_transformers(parent)[<span class="hljs-number">1</span>]
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> </span>get_loop_control parent
  partition_transformers(parent)[<span class="hljs-number">0</span>]
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>We reopen <em>Transformer</em> class to add the parts for converting XML to
minilanguage.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Transformer</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>For a given transformer class name (the one without the package) and
present in the class attribute of the transformer element in
<em>aAUTOMATOR’s</em> XML. It returns the appropriate subclass of
<em>Transformer</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.get_class_for simple_java_class_name
    subclasses_by_name[simple_java_class_name.to_sym]
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.subclasses_by_name
    <span class="hljs-variable">@@subclasses</span>.inject(<span class="hljs-constant">Hash</span>.new) {|acc, subclass|
      acc[subclass.transformer_class_symbol] = subclass
      acc
    }
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>It converts the provided transformer element to a subpart of the
resulting minilanguage. For generating the children we use
<code>children_content</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.to_minilanguage element, &amp;children_content</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>We extract the params to use.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    params = with_defaults(extract_params_from_element(element))</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>If no further transformer children we generate the call.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    loop_control, children = partition_transformers(element)
    <span class="hljs-keyword">if</span> children.empty?
      as_call(params)</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>If both branch parameters are equal to the default values it’s a pipe.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span>
      is_pipe = [<span class="hljs-symbol">:branchtype</span>, <span class="hljs-symbol">:branchmergemode</span>].all?{|key|
        params[key] == <span class="hljs-variable">@@default_values</span>[key]
      }
      <span class="hljs-keyword">if</span> is_pipe
        generate_pipe params, children_content
      <span class="hljs-keyword">else</span>
        branch_parameters = [<span class="hljs-symbol">:branchtype</span>, <span class="hljs-symbol">:branchmergemode</span>].map {|key|
          params[key].to_sym
        }
        generate_branch branch_parameters, params, children_content
      <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>It generates the string for a pipe. If the type is a
<em>SimpleTransformer</em> a <code>pipe</code> call is generated. Otherwise we use the
<em>Language</em> method name for the class.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.generate_pipe params, children_content
    result = <span class="hljs-string">""</span>
    result &lt;&lt; ((<span class="hljs-keyword">self</span> != <span class="hljs-constant">SimpleTransformer</span>) &amp;&amp; language_method_name || <span class="hljs-string">"pipe"</span>)
    <span class="hljs-keyword">unless</span> params.empty? || <span class="hljs-keyword">self</span> == <span class="hljs-constant">SimpleTransformer</span>
      result &lt;&lt; <span class="hljs-string">"("</span> &lt;&lt; as_named_arguments(params) &lt;&lt; <span class="hljs-string">")"</span>
    <span class="hljs-keyword">end</span>
    result &lt;&lt; <span class="hljs-string">" {"</span>
    result  &lt;&lt; children_content.call(<span class="hljs-string">" | "</span>) &lt;&lt; <span class="hljs-string">"}"</span>
    result
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>It generates the string for a branch. If the type is a
<em>SimpleTransformer</em> a <code>branch</code> call is generated. Otherwise we use
the <em>Language</em> method name for the class.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.generate_branch branch_parameters, params, children_content
    result = <span class="hljs-string">""</span>
    result &lt;&lt; ((<span class="hljs-keyword">self</span> != <span class="hljs-constant">SimpleTransformer</span>) &amp;&amp; language_method_name || <span class="hljs-string">"branch"</span>)
    result &lt;&lt; <span class="hljs-string">"(<span class="hljs-subst">#{branch_parameters[<span class="hljs-number">0</span>].inspect}</span>, <span class="hljs-subst">#{branch_parameters[<span class="hljs-number">1</span>].inspect}</span>"</span>
    <span class="hljs-keyword">unless</span> params.empty? || <span class="hljs-keyword">self</span> == <span class="hljs-constant">SimpleTransformer</span>
      result &lt;&lt; <span class="hljs-string">","</span> &lt;&lt; as_named_arguments(params)
    <span class="hljs-keyword">end</span>
    result &lt;&lt; <span class="hljs-string">") {\n  "</span>
    result &lt;&lt; children_content.call(<span class="hljs-string">"\n  "</span>)
    result &lt;&lt; <span class="hljs-string">"\n}"</span>
    result
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.extract_params_from_element element</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>We extract the params that come from the transformer element attributes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    params = params_from_xml_attributes element</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>Each child param element have a key attribute and its value as text content.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    children_list(element).select_with_name(<span class="hljs-string">"param"</span>).each <span class="hljs-keyword">do</span> |param_element|
      key = param_element.getAttribute(<span class="hljs-string">'key'</span>).to_sym
      value = param_element.getTextContent.to_s.strip</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>If the parameter element value is different than the default we
assign it to the params.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">unless</span> omitting_would_produce_same_value?(key, value)
        params[key] = value
      <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
    params
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>The parameters that come from the attributes are the ones defined in
<code>@@default_values</code>: <code>:branchtype</code> and <code>:branchmergemode</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.params_from_xml_attributes element
    params = {}
    <span class="hljs-variable">@@default_values</span>.each_pair <span class="hljs-keyword">do</span> |key, default_value|
      attrValue = element.getAttribute(key.to_s)</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>Only if the attribute value is different than the default value we
assign it to the params. The loop attribute is ignored here too.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">unless</span> are_equal?(default_value, attrValue)
        params[key] = attrValue <span class="hljs-keyword">if</span> key != <span class="hljs-symbol">:loop</span>
      <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
    params
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>It produces the same value if it has the same value as the default
value for the key.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.omitting_would_produce_same_value? key, value
    default_value = with_defaults({})[key]
    are_equal?(default_value, value)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.are_equal?(value, dom_value)
    dom_value == value || dom_value == value.to_s
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>We strip the braces from the params hash. As the call only has one
argument, we can provide the hash as named parameters. If params are
empty only the method name is needed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.as_call params
    result = <span class="hljs-string">"<span class="hljs-subst">#{language_method_name}</span>"</span>
    <span class="hljs-keyword">unless</span> params.empty?
      result &lt;&lt; <span class="hljs-string">"("</span>
      result &lt;&lt; as_named_arguments(params)
      result &lt;&lt; <span class="hljs-string">")"</span>
    <span class="hljs-keyword">end</span>
    result
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span><span class="hljs-keyword">self</span>.as_named_arguments params
    /{(.*)}/.match(params.inspect)[<span class="hljs-number">1</span>]
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>Factory method for easily generating the <em>NodeList</em> for an element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> </span>children_list element
  <span class="hljs-constant">NodeList</span>.new(element.getChildNodes)
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p><em>NodeList</em> is a wrapper around a java NodeList that makes some
operations less verbose.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NodeList</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>We enrich this class with a lot of useful methods by including
Enumerable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">include</span> <span class="hljs-constant">Enumerable</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>initialize node_list
    <span class="hljs-variable">@node_list</span> = node_list
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>We expose the wrapped object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:node_list</span></pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>Needed method for supporting Enumerable module.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>each
    (<span class="hljs-number">0</span>...node_list.getLength()).each <span class="hljs-keyword">do</span> |i|
      <span class="hljs-keyword">yield</span> node_list.item(i)
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>Return all children with the provided name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>select_with_name name
    select{|n| n.java_kind_of?(<span class="hljs-constant">XML::Element</span>) &amp;&amp; name == n.nodeName}
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
